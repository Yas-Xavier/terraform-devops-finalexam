pipeline {
    agent any

    environment {
        // Your SSH key credential stored in Jenkins
        //SSH_KEY = credentials('ssh-production-key')
        
        // Public IPs of your EC2 instances (replace with your own)
        TESTING_SERVER     = "x"
        STAGING_SERVER     = "y"
        PRODUCTION_SERVER1 = "z"
        PRODUCTION_SERVER2 = "d
      
        // GitHub repo for Tic Tac Toe
        REPO_URL = ""

        // Selenium test file
        SELENIUM_SCRIPT = ""

        // Temp file to store test results
        TEST_RESULT_FILE = "test_result.txt"
    }

    stages {

        stage('Deploy to Testing') {
            steps {
                echo "üöÄ Deploying Tic-Tac-Toe app to Testing Environment..."
                script {
                    sh '''
                    ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no ec2-user@$TESTING_SERVER '
                        sudo rm -rf /var/www/html/*
                        sudo dnf update -y
                        sudo dnf install -y git httpd
                        sudo systemctl enable httpd
                        sudo systemctl start httpd
                        sudo git clone '"$REPO_URL"' /var/www/html
                        sudo chown -R apache:apache /var/www/html
                    '
                    '''
                }
            }
        }

        stage('Run Selenium Tests') {
            steps {
                echo "üß™ Running Selenium tests in Testing Environment..."
                script {
                    try {
                        sh '''
                        node $SELENIUM_SCRIPT
                        echo "true" > $TEST_RESULT_FILE
                        '''
                        echo "‚úÖ Selenium tests passed."
                    } catch (Exception e) {
                        sh 'echo "false" > $TEST_RESULT_FILE'
                        echo "‚ùå Selenium tests failed."
                    }
                }
            }
        }

        stage('Deploy to Staging') {
            when {
                expression {
                    return fileExists(env.TEST_RESULT_FILE) && readFile(env.TEST_RESULT_FILE).trim() == "true"
                }
            }
            steps {
                echo "üöÄ Deploying to Staging Environment..."
                script {
                    sh '''
                    ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no ec2-user@$STAGING_SERVER '
                        sudo rm -rf /var/www/html/*
                        sudo dnf update -y
                        sudo dnf install -y git httpd
                        sudo systemctl enable httpd
                        sudo systemctl start httpd
                        sudo git clone '"$REPO_URL"' /var/www/html
                        sudo chown -R apache:apache /var/www/html
                    '
                    '''
                }
            }
        }

        stage('Deploy to Production') {
            when {
                expression {
                    return fileExists(env.TEST_RESULT_FILE) && readFile(env.TEST_RESULT_FILE).trim() == "true"
                }
            }
            steps {
                echo "üöÄ Deploying to both Production servers..."
                script {
                    def servers = [env.PRODUCTION_SERVER1, env.PRODUCTION_SERVER2]
                    for (server in servers) {
                        sh """
                        ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no ec2-user@${server} '
                            sudo rm -rf /var/www/html/*
                            sudo dnf update -y
                            sudo dnf install -y git httpd
                            sudo systemctl enable httpd
                            sudo systemctl start httpd
                            sudo git clone ${REPO_URL} /var/www/html
                            sudo chown -R apache:apache /var/www/html
                        '
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Cleaning up temporary files..."
            sh "rm -f ${TEST_RESULT_FILE}"
        }
        success {
            echo "‚úÖ Pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check console output for details."
        }
    }
}
